<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Model Building • RandomActsofPizza</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/journal/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">Random Acts of Pizza</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/index.html">Analysis</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://ryankuhn.net">ryankuhn.net</a>
</li>
<li>
  <a href="https://github.com/kuhnrl30/RandomActsofPizza">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Model Building</h1>
                        <h4 class="author">Ryan Kuhn</h4>
            
            <h4 class="date">April 17, 2017</h4>
          </div>

    
    
<div class="contents">
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This vignette covers to process to train the models and predict against the test dataset. This is the continuation from the Exploratory Analysis already performed. The Exploratory Analysis vignette covers loading the raw data, converted to tabular format, and exploration to develop hypothesis. To see the Exploratory Analysis, read the vignette.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">vignette</span>(<span class="st">"ExploratoryAnalysis"</span>)</code></pre></div>
<div id="setup-the-environent" class="section level3">
<h3 class="hasAnchor">
<a href="#setup-the-environent" class="anchor"></a>Setup the Environent</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(RandomActsofPizza)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(caret)
<span class="kw">library</span>(rpart.plot)
<span class="kw">data</span>(train)
<span class="kw">data</span>(test)</code></pre></div>
</div>
</div>
<div id="naive-model" class="section level2">
<h2 class="hasAnchor">
<a href="#naive-model" class="anchor"></a>Naive Model</h2>
<p>The naive model sets the baseline to which all other models are compared. It is the simple percentage of how many of the lines in the training dataset were successful. If the percentage is greater than 50% then we’d assume that all requests are successful. If less than 50%, then we’d assume none were successful. In this case, the success rate is only 24.5% so we’d assume that all requests for pizza would fail and would be correct 75.5% of the time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">train %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">N=</span><span class="kw">length</span>(received_pizza),
              <span class="dt">Success=</span><span class="kw">sum</span>(received_pizza)) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Percent=</span><span class="kw">paste</span>(<span class="kw">round</span>(Success/N,<span class="dv">3</span>)*<span class="dv">100</span>,<span class="st">"%"</span>,<span class="dt">sep=</span><span class="st">""</span>))</code></pre></div>
<pre><code>     N Success Percent
1 4040     994   24.6%</code></pre>
</div>
<div id="train-the-models" class="section level2">
<h2 class="hasAnchor">
<a href="#train-the-models" class="anchor"></a>Train the Models</h2>
<div id="setup-parallel-processing" class="section level3">
<h3 class="hasAnchor">
<a href="#setup-parallel-processing" class="anchor"></a>Setup parallel processing</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(doParallel)
cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(<span class="dv">2</span>)
<span class="kw">registerDoParallel</span>(cl)</code></pre></div>
<div id="logistic-regression-model" class="section level4">
<h4 class="hasAnchor">
<a href="#logistic-regression-model" class="anchor"></a>Logistic Regression Model</h4>
<p>The target in this challenge is binary and the values can only be values of 1 or 0. The requester either successfully receives a pizza or does not receive a pizza. We will use logistic regression because it will produce probability that the target value is 1.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">train &lt;-<span class="st"> </span>train %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">received_pizza=</span> <span class="kw">factor</span>(received_pizza, <span class="dt">labels=</span><span class="kw">c</span>(<span class="st">"N"</span>,<span class="st">"Y"</span>)))

glm_ctrl&lt;-<span class="st"> </span><span class="kw">trainControl</span>(<span class="dt">method=</span><span class="st">"repeatedCV"</span>,
                        <span class="dt">number=</span><span class="dv">10</span>,
                        <span class="dt">repeats=</span><span class="dv">10</span>,
                        <span class="dt">classProbs=</span><span class="ot">TRUE</span>,
                        <span class="dt">summaryFunction =</span> twoClassSummary,
                        <span class="dt">allowParallel =</span> <span class="ot">TRUE</span>)

LogMdl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/train.html">train</a></span>(<span class="dt">y=</span>train$received_pizza,
                <span class="dt">x=</span><span class="kw">subset</span>(train, <span class="dt">select=</span>-received_pizza),
                <span class="dt">method=</span><span class="st">"glm"</span>,
                <span class="dt">metric=</span><span class="st">"ROC"</span>,
                <span class="dt">trControl=</span>glm_ctrl,
                <span class="dt">family=</span> <span class="st">"binomial"</span>) 


<span class="kw">stopCluster</span>(cl)</code></pre></div>
<p>We see from the model summary below that there are a few variables with significant impact on the results. It is interesting that none of the days of the week had a significant impact. I would have expected it to have some difference between the weekdays or weekends. Also interesting is that the word ‘Thank’ has a high significance suggesting that a request saying thank you may have higher success rate.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(LogMdl)</code></pre></div>
<pre><code>
Call:
NULL

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-1.9229  -0.6337  -0.4751  -0.2731   2.4693  

Coefficients:
                                Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                   -2.009e+00  2.090e-01  -9.611  &lt; 2e-16 ***
giver_username_if_known        1.923e+01  2.206e+02   0.087 0.930521    
account_age_in_days            1.019e-03  2.672e-04   3.813 0.000137 ***
days_since_first_post_on_raop  2.242e-03  6.247e-04   3.589 0.000333 ***
number_of_comments            -2.510e-04  3.952e-04  -0.635 0.525273    
number_of_comments_in_raop     2.530e-02  2.563e-02   0.987 0.323575    
number_of_posts               -1.664e-03  1.521e-03  -1.094 0.273913    
number_of_posts_on_raop        8.268e-01  1.453e-01   5.691 1.26e-08 ***
number_of_subreddits           6.001e-03  3.826e-03   1.568 0.116771    
upvotes_minus_downvotes        3.400e-05  4.298e-05   0.791 0.428842    
upvotes_plus_downvotes        -2.097e-06  6.445e-06  -0.325 0.744880    
Year2012                      -7.803e-01  1.077e-01  -7.243 4.39e-13 ***
Year2013                      -1.092e+00  1.271e-01  -8.593  &lt; 2e-16 ***
weekdayMonday                  2.172e-01  1.666e-01   1.304 0.192182    
weekdaySaturday                3.483e-02  1.739e-01   0.200 0.841298    
weekdaySunday                  5.138e-02  1.704e-01   0.302 0.762986    
weekdayThursday                1.954e-01  1.686e-01   1.159 0.246504    
weekdayTuesday                -1.108e-01  1.728e-01  -0.641 0.521316    
weekdayWednesday              -1.358e-01  1.668e-01  -0.814 0.415478    
Image                          7.910e-01  2.684e-01   2.947 0.003205 ** 
Acct.Age                      -7.260e-01  2.042e-01  -3.555 0.000378 ***
BnRAOP                         1.038e+00  5.265e-01   1.972 0.048627 *  
Words                         -1.340e-03  1.496e-03  -0.896 0.370297    
Word.bin                       2.735e-01  1.156e-01   2.366 0.017959 *  
anyon                          2.734e-01  1.105e-01   2.474 0.013356 *  
anyth                          8.646e-02  1.224e-01   0.706 0.480035    
appreci                       -6.603e-02  1.232e-01  -0.536 0.591891    
broke                          1.431e-01  1.136e-01   1.259 0.207886    
can                           -3.397e-02  7.000e-02  -0.485 0.627501    
day                            2.220e-01  7.307e-02   3.038 0.002380 ** 
dont                          -4.092e-02  8.568e-02  -0.478 0.632967    
eat                           -6.789e-02  9.849e-02  -0.689 0.490667    
even                           3.790e-02  1.153e-01   0.329 0.742377    
food                           6.044e-02  7.565e-02   0.799 0.424292    
forward                        1.476e-01  1.476e-01   1.000 0.317479    
friend                        -4.461e-01  1.287e-01  -3.468 0.000525 ***
get                           -3.478e-02  6.214e-02  -0.560 0.575688    
give                          -1.279e-01  1.268e-01  -1.009 0.313150    
got                            1.095e-01  9.858e-02   1.111 0.266604    
help                           9.962e-02  7.040e-02   1.415 0.157071    
hungri                        -3.210e-01  1.490e-01  -2.154 0.031221 *  
ill                           -3.356e-02  1.231e-01  -0.273 0.785040    
ive                            5.817e-02  8.359e-02   0.696 0.486524    
job                            2.046e-02  7.938e-02   0.258 0.796574    
just                          -9.298e-06  6.517e-02   0.000 0.999886    
know                          -1.087e-01  1.100e-01  -0.988 0.323241    
last                           1.337e-01  9.187e-02   1.456 0.145516    
like                          -3.236e-03  9.212e-02  -0.035 0.971982    
live                          -9.742e-02  1.013e-01  -0.961 0.336408    
love                          -9.379e-02  9.604e-02  -0.977 0.328801    
make                           2.310e-02  9.471e-02   0.244 0.807332    
money                         -2.667e-02  8.245e-02  -0.323 0.746330    
month                          1.096e-01  9.071e-02   1.209 0.226744    
much                           1.697e-01  1.027e-01   1.652 0.098455 .  
need                          -4.832e-02  1.073e-01  -0.450 0.652489    
new                            5.243e-03  1.175e-01   0.045 0.964422    
`next`                         2.815e-01  1.164e-01   2.419 0.015584 *  
now                            2.325e-02  1.012e-01   0.230 0.818244    
one                           -6.073e-02  9.711e-02  -0.625 0.531715    
paid                           1.523e-01  1.127e-01   1.352 0.176287    
pay                            1.477e-01  9.847e-02   1.500 0.133611    
realli                        -7.838e-03  7.459e-02  -0.105 0.916306    
right                          8.767e-02  1.384e-01   0.633 0.526543    
someon                         7.808e-02  1.045e-01   0.747 0.455076    
thank                          3.174e-01  8.376e-02   3.789 0.000151 ***
time                           6.117e-02  8.967e-02   0.682 0.495092    
today                         -8.496e-02  1.128e-01  -0.753 0.451410    
tonight                        1.908e-01  1.152e-01   1.656 0.097626 .  
tri                           -2.443e-02  1.203e-01  -0.203 0.839110    
want                           1.958e-02  1.007e-01   0.194 0.845799    
week                           8.757e-03  7.647e-02   0.115 0.908826    
will                          -3.966e-02  7.277e-02  -0.545 0.585783    
work                           7.882e-02  7.012e-02   1.124 0.261016    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4508.2  on 4039  degrees of freedom
Residual deviance: 3245.0  on 3967  degrees of freedom
AIC: 3391

Number of Fisher Scoring iterations: 16</code></pre>
</div>
<div id="classification-model" class="section level4">
<h4 class="hasAnchor">
<a href="#classification-model" class="anchor"></a>Classification Model</h4>
<p>Classification and Regression (CART) models split the the dataset by variable to minimize the variance in each split. In the plot below, you see that the right fork has no failed requests and only 287 successful requests.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(<span class="dv">2</span>)
<span class="kw">registerDoParallel</span>(cl)

Cart_ctrl&lt;-<span class="st"> </span><span class="kw">trainControl</span>(<span class="dt">method=</span><span class="st">"cv"</span>,
                        <span class="dt">number=</span><span class="dv">10</span>,
                        <span class="dt">classProbs=</span><span class="ot">TRUE</span>,
                        <span class="dt">summaryFunction =</span> twoClassSummary,
                        <span class="dt">allowParallel =</span> <span class="ot">TRUE</span>)

CartMdl&lt;-<span class="st"> </span><span class="kw"><a href="../reference/train.html">train</a></span>(<span class="dt">y=</span>train$received_pizza,
                <span class="dt">x=</span><span class="kw">subset</span>(train, <span class="dt">select=</span>-received_pizza),
                <span class="dt">metric=</span><span class="st">"ROC"</span>,
                <span class="dt">method=</span><span class="st">"rpart"</span>,
                <span class="dt">trControl=</span> Cart_ctrl,
                <span class="dt">cp=</span>.<span class="dv">05</span>)



<span class="kw">stopCluster</span>(cl)


<span class="kw">prp</span>(CartMdl$finalModel,
    <span class="dt">main=</span> <span class="st">"RAOP Classification Tree"</span>,
    <span class="dt">extra=</span><span class="dv">1</span>,
    <span class="dt">box.col=</span><span class="kw">c</span>(<span class="st">"pink"</span>,<span class="st">"palegreen"</span>)[CartMdl$frame$yval],
    <span class="dt">leaf.round=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="ModelBuilding_files/figure-html/traincart-1.png" width="672"></p>
</div>
<div id="score-the-models" class="section level4">
<h4 class="hasAnchor">
<a href="#score-the-models" class="anchor"></a>Score the Models</h4>
<p>With the models trained, we’ll use confusion matrices to understand how accurate the models are. Both models have similar accuracy scores. The logistic regression and CART models showed 83 accuracy%. Both of these are significant improvements over the naive model with 75% accuracy.</p>
<p>We’ll take the 60/40 weighted average of the predicted probabilities from these two models. This should give a better result on the test dataset.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">LogScore&lt;-<span class="st"> </span><span class="kw">predict</span>(LogMdl, <span class="dt">data=</span>train, <span class="dt">type=</span><span class="st">"prob"</span>)
<span class="kw">confusionMatrix</span>(LogScore[,<span class="dv">2</span>]&gt;.<span class="dv">5</span>, train$received_pizza==<span class="st">"Y"</span>, <span class="dt">positive=</span><span class="st">"TRUE"</span>)</code></pre></div>
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction FALSE TRUE
     FALSE  2995  613
     TRUE     51  381
                                          
               Accuracy : 0.8356          
                 95% CI : (0.8239, 0.8469)
    No Information Rate : 0.754           
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
                                          
                  Kappa : 0.4528          
 Mcnemar's Test P-Value : &lt; 2.2e-16       
                                          
            Sensitivity : 0.38330         
            Specificity : 0.98326         
         Pos Pred Value : 0.88194         
         Neg Pred Value : 0.83010         
             Prevalence : 0.24604         
         Detection Rate : 0.09431         
   Detection Prevalence : 0.10693         
      Balanced Accuracy : 0.68328         
                                          
       'Positive' Class : TRUE            
                                          </code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">CartScore&lt;-<span class="st"> </span><span class="kw">predict</span>(CartMdl, <span class="dt">data=</span>train, <span class="dt">type=</span><span class="st">"prob"</span>)
<span class="kw">confusionMatrix</span>(CartScore[,<span class="dv">2</span>]&gt;.<span class="dv">5</span>, train$received_pizza==<span class="st">"Y"</span>, <span class="dt">positive=</span><span class="st">"TRUE"</span>)</code></pre></div>
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction FALSE TRUE
     FALSE  3026  665
     TRUE     20  329
                                          
               Accuracy : 0.8304          
                 95% CI : (0.8185, 0.8419)
    No Information Rate : 0.754           
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
                                          
                  Kappa : 0.4152          
 Mcnemar's Test P-Value : &lt; 2.2e-16       
                                          
            Sensitivity : 0.33099         
            Specificity : 0.99343         
         Pos Pred Value : 0.94269         
         Neg Pred Value : 0.81983         
             Prevalence : 0.24604         
         Detection Rate : 0.08144         
   Detection Prevalence : 0.08639         
      Balanced Accuracy : 0.66221         
                                          
       'Positive' Class : TRUE            
                                          </code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">MergedScore&lt;-<span class="st"> </span><span class="kw"><a href="../reference/MergeModels.html">MergeModels</a></span>(<span class="kw">cbind</span>(LogScore[,<span class="dv">2</span>],CartScore[,<span class="dv">2</span>]),<span class="kw">c</span>(.<span class="dv">6</span>,.<span class="dv">4</span>))
<span class="kw">confusionMatrix</span>(MergedScore&gt;.<span class="dv">5</span>, train$received_pizza==<span class="st">"Y"</span>, <span class="dt">positive=</span><span class="st">"TRUE"</span>)</code></pre></div>
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction FALSE TRUE
     FALSE  3027  664
     TRUE     19  330
                                         
               Accuracy : 0.8309         
                 95% CI : (0.819, 0.8424)
    No Information Rate : 0.754          
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16      
                                         
                  Kappa : 0.4169         
 Mcnemar's Test P-Value : &lt; 2.2e-16      
                                         
            Sensitivity : 0.33199        
            Specificity : 0.99376        
         Pos Pred Value : 0.94556        
         Neg Pred Value : 0.82010        
             Prevalence : 0.24604        
         Detection Rate : 0.08168        
   Detection Prevalence : 0.08639        
      Balanced Accuracy : 0.66288        
                                         
       'Positive' Class : TRUE           
                                         </code></pre>
</div>
</div>
</div>
<div id="make-predictions-using-the-test-data" class="section level2">
<h2 class="hasAnchor">
<a href="#make-predictions-using-the-test-data" class="anchor"></a>Make Predictions Using the Test Data</h2>
<p>Finally, we’ll apply the models to the test set and create the final dataframe for submission.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">LogPred  &lt;-<span class="st"> </span><span class="kw">predict</span>(LogMdl,<span class="dt">newdata=</span>test, <span class="dt">type=</span><span class="st">"prob"</span>)
CARTPred &lt;-<span class="st"> </span><span class="kw">predict</span>(CartMdl, <span class="dt">newdata=</span>test, <span class="dt">type=</span><span class="st">"prob"</span>)
Merged&lt;-<span class="kw"><a href="../reference/MergeModels.html">MergeModels</a></span>(<span class="kw">cbind</span>(LogPred[,<span class="dv">2</span>],CARTPred[,<span class="dv">2</span>]), <span class="kw">c</span>(.<span class="dv">6</span>,.<span class="dv">4</span>))


Submit&lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">request_id=</span>test$request_id,
                    <span class="dt">received_pizza=</span>Merged)</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#naive-model">Naive Model</a></li>
      <li><a href="#train-the-models">Train the Models</a></li>
      <li><a href="#make-predictions-using-the-test-data">Make Predictions Using the Test Data</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Ryan Kuhn.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
